<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kewilayahan</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- ===== APP BAR (sama gaya Beranda) ===== -->
<div class="appbar">
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <!-- <div class="badge" aria-hidden="true"></div> -->
        <div class="logo-container">
          <img src="assets/Logo_KLH.png" alt="Logo 1" class="logo1">
          <!-- <img src="assets/UNDP_logo.png" alt="Logo 2" class="logo2 "> -->
          <b>Dashboard MoNEv Adaptasi</b>
          <!-- <small class="muted">Kewilayahan • Konsolidasi kab/kota → provinsi → nasional</small> -->
        </div>
      </div>

      <div class="userbox">
        <div class="searchbox">
          <span class="sicon" aria-hidden="true">⌕</span>
          <input id="globalSearch" type="search" placeholder="Cari sektor, wilayah, indikator, aksi..." />
        </div>

        <button class="helpbtn" id="helpBtn" type="button" title="Bantuan">?</button>
        <span class="avatar" title="User"></span>
      </div>
    </div>
  </div>

  <div class="tabbar">
    <div class="inner tabrow">
      <div class="pagehead">
        <h1>Kewilayahan</h1>
        <div class="sub">Pantau tren pelaporan dan kualitas data per wilayah.</div>
      </div>

      
      <nav class="menu menu-right">
        <div class="dd">
          <button class="dd-btn" type="button">Dashboard ▾</button>
          <div class="dd-menu">
            <a href="index.html" class="">Beranda</a>
            <a href="horizontal.html" class="">Dashboard Horizontal</a>
            <a href="vertical.html" class="active">Dashboard Vertikal</a>
            <a href="impact.html" class="">Dashboard Impact</a>
          </div>
        </div>
        <a href="horizontal_guideline.html" class="">Horizontal</a>
        <a href="vertical_guideline.html" class="">Vertikal</a>
        <a href="impact_assessment.html" class="">Impact</a>
        <a href="aksi_pembiayaan.html" class="">Aksi &amp; Pembiayaan</a>
        <a href="pelaporan.html" class="">Pelaporan</a>
        <!-- <a href="index.html" class="active">Beranda</a> -->

        <!-- <div class="dd">
          <button class="dd-btn" type="button">Horizontal ▾</button>
          <div class="dd-menu">
            <a href="horizontal.html" class="">Dashboard Horizontal</a>
            <a href="horizontal_guideline.html" class="">Guideline Horizontal</a>
          </div>
        </div>

        <div class="dd">
          <button class="dd-btn" type="button">Vertikal ▾</button>
          <div class="dd-menu">
            <a href="vertical.html" class="">Dashboard Vertikal</a>
            <a href="vertical_guideline.html" class="">Guideline Vertikal</a>
          </div>
        </div>

        <div class="dd">
          <button class="dd-btn" type="button">Impact ▾</button>
          <div class="dd-menu">
            <a href="impact.html" class="">Dashboard Impact</a>
            <a href="impact_assessment.html" class="">Impact Assessment</a>
          </div>
        </div> -->
      </nav>
    </div>
  </div>
</div>

<div class="wrap">

  <!-- ===== FILTER BAR (rapih, ga numpuk) ===== -->
  <div class="card span-12" style="margin-bottom:14px">
    <div class="bd toolbar">
      <div class="toolbar-left">
        <div class="tool">
          <label for="period">Periode</label>
          <select id="period">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
          </select>
        </div>

        <div class="tool">
          <label for="prov">Provinsi</label>
          <select id="prov"></select>
        </div>

        <div class="tool">
          <label for="kab">Kab/Kota</label>
          <select id="kab"></select>
        </div>
      </div>

      <div class="toolbar-right">
        <div class="searchbox small">
          <span class="sicon" aria-hidden="true">⌕</span>
          <input id="search" type="search" placeholder="Filter tabel (indikator/aksi/sumber data)..." />
        </div>

        <!-- <button id="btnMeta" type="button">Metadata</button>
        <button id="btnQA" type="button">QA/QC</button>
        <button class="primary" id="btnExport" type="button">Ekspor</button> -->
      </div>
    </div>
  </div>

  <section class="grid">

    <!-- KPI -->
    <div class="card span-3">
      <div class="bd kpi">
        <div class="label">Aksi Adaptasi (Wilayah)</div>
        <div class="value" id="kpiActions">—</div>
        <div class="pill" id="pillActions">SRN + SIPD</div>
      </div>
    </div>

    <div class="card span-3">
      <div class="bd kpi">
        <div class="label">Indikator Terlapor</div>
        <div class="value" id="kpiIndicators">—</div>
        <div class="pill">Lampiran III</div>
      </div>
    </div>

    <div class="card span-3">
      <div class="bd kpi">
        <div class="label">Aksi Bertag CBT</div>
        <div class="value" id="kpiCBT">—</div>
        <div class="pill">Pembiayaan</div>
      </div>
    </div>

    <div class="card span-3">
      <div class="bd kpi">
        <div class="label">Kualitas Data</div>
        <div class="value" id="kpiQuality">—</div>
        <div class="pill good" id="pillQuality">QA/QC</div>
      </div>
    </div>

    <!-- Peta -->
    <div class="card span-7">
      <div class="hd">
        <div>
          <div class="h">Peta Tematik Wilayah (Placeholder)</div>
          <div class="s">Aksi terdaftar, kelengkapan indikator, dan isu kualitas data.</div>
        </div>
        <span class="pill">Peta</span>
      </div>
      <div class="bd">
        <div class="map" id="mapBox">
          Area peta (placeholder).<br/>
          Nantinya dapat menampilkan layer per kab/kota, termasuk status verifikasi.
        </div>
        <div class="footer-note">Integrasi WebGIS (Leaflet/Mapbox) bisa ditambahkan pada tahap dev.</div>
      </div>
    </div>

    <!-- Tren -->
    <div class="card span-5">
      <div class="hd">
        <div>
          <div class="h">Tren Pelaporan Wilayah</div>
          <div class="s">Kelengkapan indikator antarperiode.</div>
        </div>
        <span class="pill">Grafik</span>
      </div>
      <div class="bd">
        <canvas id="trendChart" width="900" height="320" aria-label="Tren Pelaporan Wilayah"></canvas>
        <div class="footer-note">Membantu prioritisasi verifikasi sebelum penguncian periode.</div>
      </div>
    </div>

    <!-- Tabel -->
    <div class="card span-12">
      <div class="hd">
        <div>
          <div class="h">Ringkasan Indikator & Aksi</div>
          <div class="s">Filter per provinsi/kab-kota dan status QA/QC.</div>
        </div>
        <span class="pill">Tabel</span>
      </div>
      <div class="bd">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:18%">Indikator / Aksi</th>
                <th style="width:16%">Unit Pelapor</th>
                <th style="width:18%">Sumber Data</th>
                <th style="width:22%">Keterpautan Sistem</th>
                <th style="width:14%">Status</th>
                <th style="width:12%">Catatan</th>
              </tr>
            </thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
        <div class="footer-note">Tabel ini menjaga konsistensi ringkasan lintas periode untuk pelaporan nasional.</div>
      </div>
    </div>

  </section>
  <div class="actions">
    <button id="btnMeta">Lihat Metadata</button>
    <button id="btnQA">Lihat Ringkasan QA/QC</button>
    <button class="primary" id="btnExport">Ekspor Ringkasan Sektor</button>
  </div>
</div>

<!-- ===== MODAL DETAIL (metadata / QA/QC) ===== -->
<div class="modal" id="modal">
  <div class="box">
    <div class="hd">
      <h3 id="modalTitle" style="margin:0">Detail</h3>
      <button id="btnClose" type="button">Tutup</button>
    </div>
    <div class="bd" id="modalBody"></div>
  </div>
</div>

<!-- ===== HELP MODAL ===== -->
<div class="modal" id="helpModal">
  <div class="box">
    <div class="hd">
      <b>Bantuan</b>
      <button class="iconclose" id="helpClose" type="button">✕</button>
    </div>
    <div class="bd">
      <ul class="help-list">
        <li><b>Periode / Provinsi / Kab-Kota</b>: mengubah ringkasan KPI, tren, dan isi tabel.</li>
        <li><b>Filter tabel</b>: menyaring baris berdasarkan kata kunci indikator/aksi/sumber data.</li>
        <li><b>Metadata</b>: contoh ringkasan rujukan sistem (SIPD, SRN, AKSARA, CBT).</li>
        <li><b>QA/QC</b>: ringkasan isu umum untuk prioritas verifikasi wilayah.</li>
        <li><b>Ekspor</b>: menghasilkan file .txt ringkasan (dummy).</li>
      </ul>
      <div class="footer-note">Catatan: Search global di kanan atas belum lintas halaman (bisa kita sambungkan nanti).</div>
    </div>
  </div>
</div>

<script>
  const DATA = {
    "2023": {
      "DKI Jakarta": {
        kabs:["Jakarta Utara","Jakarta Barat","Jakarta Pusat","Jakarta Timur","Jakarta Selatan","Kepulauan Seribu"],
        rows:[
          {item:"Aksi perlindungan pesisir & rob", unit:"Pemprov/Pemkot", src:"SIPD (program), SRN (aksi)", sys:["SIPD","SRN","CBT"], st:"Berjalan", note:"Butuh verifikasi lokasi"},
          {item:"Kesiapsiagaan heat-health", unit:"Dinkes", src:"Pelaporan layanan & rencana kontinjensi", sys:["SIPD","AKSARA"], st:"Lengkap", note:"Metadata tersedia"},
          {item:"Pengelolaan banjir/drainase adaptif", unit:"Dinas PU", src:"Kinerja infrastruktur & kejadian", sys:["SIPD","AKSARA","CBT"], st:"Perlu Verifikasi", note:"Sampling QA"},
        ],
        kpi:{actions:140, indicators:15, cbt:62, quality:91},
        trend:[{p:"2023",v:76},{p:"2024",v:80},{p:"2025",v:84}]
      },
      "Jawa Tengah": {
        kabs:["Semarang","Demak","Pekalongan","Cilacap","Surakarta"],
        rows:[
          {item:"Adaptasi pertanian tahan kekeringan", unit:"Dinas Pertanian", src:"Produksi, kerentanan, program", sys:["SIPD","AKSARA","CBT"], st:"Berjalan", note:"Definisi indikator diselaraskan"},
          {item:"Aksi konservasi DAS & tata air", unit:"Pemprov/Pemkab", src:"Program wilayah & monitoring", sys:["SIPD","SRN"], st:"Berjalan", note:"Konsolidasi lintas kab"},
          {item:"Peringatan dini banjir/longsor", unit:"BPBD", src:"Layanan, kejadian, respons", sys:["SIPD"], st:"Perlu Verifikasi", note:"Validasi kejadian"},
        ],
        kpi:{actions:210, indicators:16, cbt:75, quality:89},
        trend:[{p:"2023",v:72},{p:"2024",v:75},{p:"2025",v:79}]
      },
      "Kalimantan Tengah": {
        kabs:["Palangka Raya","Katingan","Kotawaringin Timur","Kapuas"],
        rows:[
          {item:"Pencegahan karhutla berbasis lanskap", unit:"BPBD/Dinas Kehutanan", src:"Hotspot, patroli, restorasi", sys:["SIPD","SRN","CBT"], st:"Berjalan", note:"Butuh QA spasial"},
          {item:"Penguatan layanan iklim untuk pertanian", unit:"Dinas Pertanian/BMKG", src:"Layanan iklim & adopsi", sys:["SIPD"], st:"Lengkap", note:"Seri waktu tersedia"},
          {item:"Perlindungan sosial adaptif", unit:"Dinsos", src:"Bantuan, targeting", sys:["SIPD","CBT"], st:"Perlu Verifikasi", note:"Cek konsistensi periode"},
        ],
        kpi:{actions:165, indicators:14, cbt:58, quality:90},
        trend:[{p:"2023",v:70},{p:"2024",v:74},{p:"2025",v:78}]
      }
    },
    "2024": {},
    "2025": {}
  };

  DATA["2024"] = JSON.parse(JSON.stringify(DATA["2023"]));
  DATA["2025"] = JSON.parse(JSON.stringify(DATA["2023"]));

  function tweak(period){
    const factor = period==="2024" ? 1.06 : (period==="2025" ? 1.14 : 1.0);
    for(const prov in DATA[period]){
      const o = DATA[period][prov];
      o.kpi.actions = Math.round(o.kpi.actions*factor);
      o.kpi.cbt = Math.round(o.kpi.cbt*factor);
      o.kpi.quality = Math.min(95, o.kpi.quality + (period==="2025"?2:(period==="2024"?1:0)));
      o.trend = o.trend.map((x)=> ({p:x.p, v: Math.min(98, x.v + (period==="2025"?6:(period==="2024"?3:0)))}));
    }
  }
  tweak("2024"); tweak("2025");

  const $ = (id) => document.getElementById(id);
  function formatInt(n){ return new Intl.NumberFormat("id-ID").format(n); }

  function qualityPill(q){
    if(q >= 92) return {cls:"good", txt:"Baik"};
    if(q >= 90) return {cls:"warn", txt:"Cukup"};
    return {cls:"bad", txt:"Perlu Perbaikan"};
  }

  function renderStatus(st){
    const s = st.toLowerCase();
    let cls = "warn";
    if(s.includes("lengkap")) cls="good";
    if(s.includes("perlu")) cls="bad";
    return `<span class="tag ${cls}">${st}</span>`;
  }

  // Charts
  function clear(ctx, w, h){
    ctx.clearRect(0,0,w,h);
    ctx.save();
    ctx.globalAlpha = 0.12;
    ctx.strokeStyle = "rgba(15,23,42,.45)";
    for(let x=40; x<w; x+=60){ ctx.beginPath(); ctx.moveTo(x, 20); ctx.lineTo(x, h-40); ctx.stroke(); }
    for(let y=20; y<h-40; y+=50){ ctx.beginPath(); ctx.moveTo(40, y); ctx.lineTo(w-20, y); ctx.stroke(); }
    ctx.restore();
  }

  function drawAxes(ctx, w, h, xLabel, yLabel){
    ctx.save();
    ctx.strokeStyle = "rgba(15,23,42,.55)";
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(40, 20); ctx.lineTo(40, h-40); ctx.lineTo(w-20, h-40); ctx.stroke();
    ctx.fillStyle = "rgba(15,23,42,.70)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText(yLabel, 40, 14);
    ctx.fillText(xLabel, w-120, h-16);
    ctx.restore();
  }

  function drawLineChart(series){
    const c = $("trendChart");
    const ctx = c.getContext("2d");
    const w = c.width, h = c.height;

    clear(ctx,w,h);
    drawAxes(ctx,w,h,"Periode","% Kelengkapan");

    const maxV = 100;
    const minV = 0;
    const innerW = w-60, innerH = h-70;
    const x0 = 40, y0 = h-40;

    ctx.save();
    ctx.fillStyle = "rgba(15,23,42,.68)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    series.forEach((d,i)=>{
      const x = x0 + (innerW*(i/(series.length-1)));
      ctx.fillText(d.p, x-14, h-18);
    });
    ctx.restore();

    ctx.save();
    ctx.strokeStyle = "rgba(37,99,235,.95)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    series.forEach((d,i)=>{
      const x = x0 + (innerW*(i/(series.length-1)));
      const y = y0 - (innerH*((d.v-minV)/(maxV-minV)));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.fillStyle = "rgba(6,182,212,.95)";
    series.forEach((d,i)=>{
      const x = x0 + (innerW*(i/(series.length-1)));
      const y = y0 - (innerH*((d.v-minV)/(maxV-minV)));
      ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = "rgba(15,23,42,.78)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText(d.v + "%", x-14, y-10);
      ctx.fillStyle = "rgba(6,182,212,.95)";
    });
    ctx.restore();
  }

  // Modal
  const modal = $("modal");
  function openModal(title, html){
    $("modalTitle").textContent = title;
    $("modalBody").innerHTML = html;
    modal.style.display = "flex";
  }
  function closeModal(){ modal.style.display = "none"; }
  $("btnClose").addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

  function initSelectors(){
    const provSel = $("prov");
    provSel.innerHTML = "";
    const provs = Object.keys(DATA["2025"]).sort();
    provs.forEach(p=>{
      const o = document.createElement("option");
      o.value = p; o.textContent = p;
      provSel.appendChild(o);
    });
    provSel.value = "DKI Jakarta";
    updateKab();
  }

  function updateKab(){
    const period = $("period").value;
    const prov = $("prov").value;
    const kabSel = $("kab");
    kabSel.innerHTML = "";
    const kabs = DATA[period][prov].kabs || [];
    const all = document.createElement("option");
    all.value = "__ALL__";
    all.textContent = "Semua Kab/Kota";
    kabSel.appendChild(all);
    kabs.forEach(k=>{
      const o = document.createElement("option");
      o.value = k; o.textContent = k;
      kabSel.appendChild(o);
    });
    kabSel.value = "__ALL__";
  }

  function render(){
    const period = $("period").value;
    const prov = $("prov").value;
    const kab = $("kab").value;
    const q = $("search").value.trim().toLowerCase();

    const d = DATA[period][prov];

    $("kpiActions").textContent = formatInt(d.kpi.actions);
    $("kpiIndicators").textContent = formatInt(d.kpi.indicators);
    $("kpiCBT").textContent = formatInt(d.kpi.cbt);
    $("kpiQuality").textContent = d.kpi.quality + "%";

    const qp = qualityPill(d.kpi.quality);
    const pill = $("pillQuality");
    pill.classList.remove("good","warn","bad");
    pill.classList.add(qp.cls);
    pill.textContent = "QA/QC: " + qp.txt;

    $("pillActions").textContent = (kab==="__ALL__") ? ("SRN+SIPD: " + prov) : ("SRN+SIPD: " + kab);

    drawLineChart(d.trend);

    $("mapBox").innerHTML = `
      <div>
        <b>${prov}</b><br/>
        Fokus: ${kab==="__ALL__" ? "konsolidasi provinsi" : kab}.<br/>
        <span style="color:rgba(71,85,105,.95)">Layer contoh:</span> aksi terdaftar, kelengkapan indikator, status verifikasi.
      </div>
    `;

    const rows = d.rows.filter(r=>{
      const blob = (r.item+" "+r.unit+" "+r.src+" "+r.sys.join(" ")+" "+r.st+" "+r.note).toLowerCase();
      return q.length===0 || blob.includes(q);
    });

    const body = $("tblBody");
    body.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${r.item}</b></td>
        <td>${r.unit}</td>
        <td>${r.src}</td>
        <td>${r.sys.map(s=>`<span class="tag">${s}</span>`).join("")}</td>
        <td>${renderStatus(r.st)}</td>
        <td>${r.note}</td>
      `;
      body.appendChild(tr);
    });
  }

  $("btnMeta").addEventListener("click", ()=>{
    const p = $("period").value, prov = $("prov").value, kab = $("kab").value;
    const d = DATA[p][prov];
    openModal("Metadata Kewilayahan (Contoh)", `
      <p>Metadata berikut bersifat contoh untuk uji UX. Implementasi aktual dapat mengambil metadata dari SIPD, SRN, serta modul QA/QC.</p>
      <ul>
        <li><b>Periode:</b> ${p}</li>
        <li><b>Wilayah:</b> ${kab==="__ALL__" ? prov : (prov+" / "+kab)}</li>
        <li><b>Rujukan sistem:</b> SIPD (pelaporan), SRN (aksi), AKSARA (perencanaan), CBT (pembiayaan)</li>
        <li><b>Indikator:</b> ${d.kpi.indicators} (konsolidasi Lampiran III)</li>
        <li><b>Kualitas data:</b> ${d.kpi.quality}%</li>
        <li><b>Catatan:</b> Tampilan deskriptif untuk monitoring & pelaporan (non-kausal).</li>
      </ul>
    `);
  });

  $("btnQA").addEventListener("click", ()=>{
    const p = $("period").value, prov = $("prov").value;
    const d = DATA[p][prov];
    const qp = qualityPill(d.kpi.quality);
    openModal("Ringkasan QA/QC (Contoh)", `
      <p>Ringkasan QA/QC membantu menentukan prioritas verifikasi wilayah sebelum penguncian periode.</p>
      <ul>
        <li><b>Status agregat:</b> ${qp.txt} (${d.kpi.quality}%)</li>
        <li><b>Isu umum:</b> definisi indikator antar kab/kota; kelengkapan metadata; konsistensi periode.</li>
        <li><b>Tindak lanjut:</b> verifikasi sampling entri <i>Perlu Verifikasi</i>; perapihan definisi & metadata.</li>
      </ul>
    `);
  });

  $("btnExport").addEventListener("click", ()=>{
    const p = $("period").value, prov = $("prov").value, kab = $("kab").value;
    const d = DATA[p][prov];
    const text = [
      "Ringkasan MoNEv Adaptasi — Kewilayahan",
      `Periode: ${p}`,
      `Wilayah: ${kab==="__ALL__" ? prov : (prov+" / "+kab)}`,
      `Aksi Adaptasi: ${d.kpi.actions}`,
      `Indikator Terlapor: ${d.kpi.indicators}`,
      `Aksi Bertag CBT: ${d.kpi.cbt}`,
      `Kualitas Data: ${d.kpi.quality}%`,
      "",
      "Catatan: file ini hasil ekspor contoh untuk uji UX."
    ].join("\n");

    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `Ringkasan_Kewilayahan_${prov.replaceAll(" ","_")}_${p}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("period").addEventListener("change", ()=>{ updateKab(); render(); });
  $("prov").addEventListener("change", ()=>{ updateKab(); render(); });
  $("kab").addEventListener("change", render);
  $("search").addEventListener("input", render);

  // Help modal
  const helpBtn = $("helpBtn");
  const helpModal = $("helpModal");
  const helpClose = $("helpClose");
  if(helpBtn && helpModal && helpClose){
    helpBtn.onclick = () => helpModal.style.display = "flex";
    helpClose.onclick = () => helpModal.style.display = "none";
    helpModal.addEventListener("click", (e) => {
      if(e.target === helpModal) helpModal.style.display = "none";
    });
  }

  // Global search (sementara: fokus ke filter tabel)
  const gs = $("globalSearch");
  if(gs){
    gs.addEventListener("input", ()=>{
      $("search").value = gs.value;
      render();
    });
  }

  initSelectors();
  render();
</script>

</body>
</html>
